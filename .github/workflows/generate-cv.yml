name: Generate CV and Upload to Cloudflare R2

on:
  push:
    branches: ['master']
    paths:
      - 'public/resume.json'
      - 'scripts/generate-cv.js'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  generate-and-upload:
    environment: 'github-pages'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install

      - name: Generate CV PDF
        run: node scripts/generate-cv.js

      - name: Get PDF filename
        id: get-pdf-filename
        run: |
          PDF_FILENAME=$(node -e "const fs=require('fs'); const path=require('path'); const data=JSON.parse(fs.readFileSync('public/resume.json')); const url=data.basics.cvPdf; const parts=url.split('/'); console.log(parts[parts.length-1]);")
          echo "Using PDF filename: $PDF_FILENAME"
          echo "pdf_filename=$PDF_FILENAME" >> $GITHUB_OUTPUT

      - name: Upload to Cloudflare R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2_BUCKET_NAME: ${{ vars.R2_BUCKET_NAME }}
        run: |
          # Use wrangler to upload the PDF to R2
          PDF_FILENAME="${{ steps.get-pdf-filename.outputs.pdf_filename }}"
          if [ -z "$PDF_FILENAME" ]; then
            PDF_FILENAME="CV_AnhBui_FullStackDev.pdf"
          fi
          # Use the locally installed wrangler with --remote flag
          ./node_modules/.bin/wrangler r2 object put "$R2_BUCKET_NAME/$PDF_FILENAME" --file "$PDF_FILENAME" --remote

      - name: Purge Cloudflare Cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ vars.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_EMAIL: ${{ vars.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_DOMAIN: ${{ vars.CLOUDFLARE_DOMAIN }}
        run: |
          # Purge the cache for the specific PDF file
          PDF_FILENAME="${{ steps.get-pdf-filename.outputs.pdf_filename }}"
          if [ -z "$PDF_FILENAME" ]; then
            PDF_FILENAME="CV_AnhBui_FullStackDev.pdf"
          fi

          # Create full URL for the file
          FULL_URL="https://$CLOUDFLARE_DOMAIN/$PDF_FILENAME"

          # Create a temporary JSON file for the purge request with full URLs
          echo '{"files":["'$FULL_URL'"]}' > purge-cache.json

          # Make the API call to purge the cache using Global API Key
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data @purge-cache.json

          # Print response for debugging
          echo "Cache purge attempted for $FULL_URL"
